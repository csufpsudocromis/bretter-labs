<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bretter Labs Console (Prototype)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1.5rem; max-width: 960px; }
    h1, h2 { margin-bottom: 0.25rem; }
    section { border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
    label { display: block; margin-top: 0.5rem; }
    input, button { margin-top: 0.25rem; }
    pre { background: #f8f8f8; padding: 0.75rem; border-radius: 4px; overflow: auto; }
    .row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 280px; }
  </style>
</head>
<body>
  <h1>Bretter Labs Console (Prototype)</h1>
  <p>Minimal HTML client for testing the API. Start the API locally then use these panels.</p>

  <section>
    <h2>Login</h2>
    <label>Username <input id="login-username" value="admin"></label>
    <label>Password <input id="login-password" type="password" value="admin"></label>
    <button onclick="login()">Login</button>
    <p>Token: <span id="token-display">(none)</span></p>
  </section>

  <section class="row">
    <div>
      <h2>Admin: Users</h2>
      <label>New username <input id="new-user"></label>
      <label>New password <input id="new-pass" type="password"></label>
      <button onclick="createUser()">Create User</button>
      <label>Reset password for user <input id="reset-user"></label>
      <label>New password <input id="reset-pass" type="password"></label>
      <button onclick="resetPassword()">Reset Password</button>
    </div>
    <div>
      <h2>Admin: Templates</h2>
      <label>Name <input id="tmpl-name"></label>
      <label>Image ID <input id="tmpl-image"></label>
      <label>CPU cores <input id="tmpl-cpu" type="number" value="2"></label>
      <label>RAM MB <input id="tmpl-ram" type="number" value="4096"></label>
      <button onclick="createTemplate()">Create Template (disabled)</button>
      <label>Template ID <input id="toggle-id"></label>
      <button onclick="toggleTemplate(true)">Enable</button>
      <button onclick="toggleTemplate(false)">Disable</button>
    </div>
  </section>

  <section class="row">
    <div>
      <h2>User: Templates</h2>
      <button onclick="listTemplates()">List Enabled Templates</button>
    </div>
    <div>
      <h2>User: Pods</h2>
      <label>Template ID to start <input id="start-template"></label>
      <button onclick="startPod()">Start VM</button>
      <label>Instance ID <input id="instance-id"></label>
      <button onclick="stopPod()">Stop</button>
      <button onclick="deletePod()">Delete</button>
      <button onclick="listPods()">List My Pods</button>
    </div>
  </section>

  <section>
    <h2>Output</h2>
    <pre id="output"></pre>
  </section>

  <script>
    let token = null;
    const base = 'http://127.0.0.1:8000';
    const output = document.getElementById('output');
    function log(data) { output.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2); }
    function authHeaders() { return token ? { 'Authorization': 'Bearer ' + token } : {}; }

    async function login() {
      const payload = { username: document.getElementById('login-username').value, password: document.getElementById('login-password').value };
      const res = await fetch(base + '/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const body = await res.json();
      if (res.ok) { token = body.token; document.getElementById('token-display').textContent = token; }
      log(body);
    }
    async function createUser() {
      const payload = { username: document.getElementById('new-user').value, password: document.getElementById('new-pass').value };
      const res = await fetch(base + '/admin/users', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify(payload) });
      log(await res.json());
    }
    async function resetPassword() {
      const user = document.getElementById('reset-user').value;
      const payload = { password: document.getElementById('reset-pass').value };
      const res = await fetch(base + '/admin/users/' + encodeURIComponent(user), { method: 'PATCH', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify(payload) });
      log(await res.json());
    }
    async function createTemplate() {
      const payload = {
        name: document.getElementById('tmpl-name').value,
        image_id: document.getElementById('tmpl-image').value,
        cpu_cores: parseInt(document.getElementById('tmpl-cpu').value, 10),
        ram_mb: parseInt(document.getElementById('tmpl-ram').value, 10),
        enabled: false
      };
      const res = await fetch(base + '/admin/templates', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify(payload) });
      log(await res.json());
    }
    async function toggleTemplate(enabled) {
      const id = document.getElementById('toggle-id').value;
      const payload = { enabled };
      const res = await fetch(base + '/admin/templates/' + encodeURIComponent(id), { method: 'PATCH', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify(payload) });
      log(await res.json());
    }
    async function listTemplates() {
      const res = await fetch(base + '/user/templates', { headers: { ...authHeaders() } });
      log(await res.json());
    }
    async function listPods() {
      const res = await fetch(base + '/user/pods', { headers: { ...authHeaders() } });
      log(await res.json());
    }
    async function startPod() {
      const tmpl = document.getElementById('start-template').value;
      const res = await fetch(base + '/user/templates/' + encodeURIComponent(tmpl) + '/start', { method: 'POST', headers: { ...authHeaders() } });
      log(await res.json());
    }
    async function stopPod() {
      const id = document.getElementById('instance-id').value;
      const res = await fetch(base + '/user/pods/' + encodeURIComponent(id) + '/stop', { method: 'POST', headers: { ...authHeaders() } });
      log(await res.json());
    }
    async function deletePod() {
      const id = document.getElementById('instance-id').value;
      const res = await fetch(base + '/user/pods/' + encodeURIComponent(id), { method: 'DELETE', headers: { ...authHeaders() } });
      log(res.status === 204 ? 'deleted' : await res.json());
    }
  </script>
</body>
</html>
