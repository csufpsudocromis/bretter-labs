<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SPICE Console</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #spice-screen {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #message-div {
        display: none;
      }
      #spice-screen canvas {
        max-width: 100vw;
        max-height: 100vh;
        width: auto !important;
        height: auto !important;
        object-fit: contain;
      }
    </style>
  </head>
  <body>
    <div id="spice-screen"></div>
    <div id="message-div"></div>
    <script type="module">
      import * as SpiceHtml5 from './main.js';

      const params = new URLSearchParams(window.location.search);
      const host = params.get('host') || window.location.hostname;
      const port = params.get('port') || window.location.port || '6080';
      const secure = params.get('secure') === '1' || window.location.protocol === 'https:';
      const password = params.get('password') || '';
      const title = params.get('title') || '';
      const scheme = secure ? 'wss://' : 'ws://';
      const uri = scheme + host + ':' + port;

      let sc;
      function connect() {
        try {
          sc = new SpiceHtml5.SpiceMainConn({
            uri,
            screen_id: 'spice-screen',
            message_id: 'message-div',
            password,
            onerror: (e) => console.error('SPICE error', e),
          });
        } catch (e) {
          console.error('Failed to start SPICE', e);
        }
      }

      window.addEventListener('load', () => {
        if (title) {
          document.title = title;
        }
        connect();
      });
      window.addEventListener('beforeunload', () => {
        if (sc) sc.stop();
      });
    </script>
  </body>
</html>
