<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SPICE Console</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #spice-screen {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #message-div {
        display: none;
      }
      #spice-screen canvas {
        max-width: 100vw;
        max-height: 100vh;
        width: auto !important;
        height: auto !important;
        object-fit: contain;
      }
      .idle-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .idle-card {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid #334155;
        padding: 1.25rem 1.5rem;
        border-radius: 12px;
        max-width: 420px;
        width: 100%;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
        font-family: Arial, sans-serif;
      }
      .idle-card h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.2rem;
      }
      .idle-card p {
        margin: 0.35rem 0;
        color: #cbd5e1;
        line-height: 1.4;
      }
      .idle-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
      }
      .idle-actions button {
        flex: 1;
        padding: 0.6rem 0.75rem;
        border-radius: 10px;
        border: 1px solid #475569;
        background: #0ea5e9;
        color: #0b1727;
        cursor: pointer;
        font-weight: 700;
      }
      .idle-actions button.ghost {
        background: transparent;
        color: #e2e8f0;
        border-color: #475569;
      }
    </style>
  </head>
  <body>
    <div id="spice-screen"></div>
    <div id="message-div"></div>
    <div id="idle-overlay" class="idle-overlay" style="display: none;">
      <div class="idle-card">
        <h3>Still using this lab?</h3>
        <p id="idle-text">No activity detected.</p>
        <p id="idle-countdown"></p>
        <div class="idle-actions">
          <button class="ghost" id="idle-stop">No, end lab</button>
          <button id="idle-continue">Yes, continue</button>
        </div>
      </div>
    </div>
    <div id="ended-overlay" class="idle-overlay" style="display: none;">
      <div class="idle-card">
        <h3>Session ended</h3>
        <p id="ended-text">Session timed out due to inactivity.</p>
      </div>
    </div>
    <script type="module">
      import * as SpiceHtml5 from './main.js';

      const params = new URLSearchParams(window.location.search);
      const host = params.get('host') || window.location.hostname;
      const port = params.get('port') || window.location.port || '6080';
      const secure = params.get('secure') === '1' || window.location.protocol === 'https:';
      const password = params.get('password') || '';
      const title = params.get('title') || '';
      const instanceId = params.get('instance_id') || '';
      const idleMinutes = parseInt(params.get('idle_minutes') || '30', 10);
      const countdownSeconds = parseInt(params.get('countdown_seconds') || '300', 10);
      const scheme = secure ? 'wss://' : 'ws://';
      const uri = scheme + host + ':' + port;

      let sc;
      let openerRef = null;
      let openerOrigin = '*';
      let idleSuspended = false;
      let presenceTimer = null;
      const PRESENCE_INTERVAL_MS = 2000;
      let authToken = '';
      let apiBase = '';
      let lastHeartbeatAt = 0;
      const HEARTBEAT_INTERVAL_MS = 30000;
      let openerWatchTimer = null;
      const OPENER_WATCH_INTERVAL_MS = 2000;
      let backendHeartbeatTimer = null;
      const BACKEND_HEARTBEAT_TICK_MS = 10000;
      const AUTH_STORAGE_TOKEN_KEY = 'blabs_vm_token';
      const AUTH_STORAGE_API_KEY = 'blabs_vm_api_base';
      function connect() {
        try {
          sc = new SpiceHtml5.SpiceMainConn({
            uri,
            screen_id: 'spice-screen',
            message_id: 'message-div',
            password,
            onerror: (e) => console.error('SPICE error', e),
          });
        } catch (e) {
          console.error('Failed to start SPICE', e);
        }
      }

      window.addEventListener('load', () => {
        if (title) {
          document.title = title;
        }
        loadStoredAuth();
        connect();
        startIdleTimer();
      });
      window.addEventListener('beforeunload', () => {
        stopPresenceHeartbeat();
        stopOpenerWatchdog();
        stopBackendHeartbeat();
        notifyOpenerFocus(false);
        if (sc) sc.stop();
      });

      // Inactivity handling inside the console tab.
      let idleTimer = null;
      let countdownTimer = null;
      let countdownEndsAt = null;
      let idleStartsAt = null;
      let promptActive = false;
      const overlay = document.getElementById('idle-overlay');
      const endedOverlay = document.getElementById('ended-overlay');
      const countdownEl = document.getElementById('idle-countdown');
      const textEl = document.getElementById('idle-text');
      const endedTextEl = document.getElementById('ended-text');

      function loadStoredAuth() {
        try {
          const storedToken = sessionStorage.getItem(AUTH_STORAGE_TOKEN_KEY);
          if (storedToken) {
            authToken = storedToken;
          }
          const storedApi = sessionStorage.getItem(AUTH_STORAGE_API_KEY);
          if (storedApi) {
            apiBase = storedApi;
          }
        } catch (err) {
          // ignore storage failures
        }
      }

      function apiBaseUrl() {
        const base = apiBase || `${window.location.protocol}//${window.location.hostname}:30080`;
        return base.replace(/\/$/, '');
      }

      function sendHeartbeat(timestamp) {
        if (!instanceId || !authToken) {
          return;
        }
        const now = timestamp || Date.now();
        if (now - lastHeartbeatAt < HEARTBEAT_INTERVAL_MS) {
          return;
        }
        lastHeartbeatAt = now;
        const base = apiBaseUrl();
        const url = `${base}/user/pods/${instanceId}/activity`;
        fetch(url, {
          method: 'POST',
          headers: { Authorization: `Bearer ${authToken}` },
          keepalive: true,
        }).catch(() => {});
      }

      function startBackendHeartbeat() {
        if (backendHeartbeatTimer) {
          return;
        }
        backendHeartbeatTimer = setInterval(() => {
          sendHeartbeat(Date.now());
        }, BACKEND_HEARTBEAT_TICK_MS);
      }

      function stopBackendHeartbeat() {
        if (!backendHeartbeatTimer) {
          return;
        }
        clearInterval(backendHeartbeatTimer);
        backendHeartbeatTimer = null;
      }

      function requestStop(action = 'delete') {
        if (!instanceId || !authToken) {
          return;
        }
        const base = apiBaseUrl();
        const url =
          action === 'delete' ? `${base}/user/pods/${instanceId}` : `${base}/user/pods/${instanceId}/stop`;
        fetch(url, {
          method: action === 'delete' ? 'DELETE' : 'POST',
          headers: { Authorization: `Bearer ${authToken}` },
          keepalive: true,
        }).catch(() => {});
      }

      function sendStop(reason = 'idle-timeout', action = 'delete') {
        requestStop(action);
        if (window.opener) {
          window.opener.postMessage({ type: 'idle-stop', instanceId, reason, action }, '*');
        }
      }

      function showEnded(reason = 'idle-timeout') {
        overlay.style.display = 'none';
        endedOverlay.style.display = 'flex';
        promptActive = false;
        stopBackendHeartbeat();
        if (endedTextEl) {
          endedTextEl.textContent =
            reason === 'idle-timeout' ? 'Session timed out due to inactivity.' : 'Session ended.';
        }
        sendStop(reason, 'delete');
      }

      function stopCountdown() {
        if (countdownTimer) {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
        overlay.style.display = 'none';
        promptActive = false;
        countdownEndsAt = null;
      }

      function endSession(reason = 'idle-timeout') {
        stopCountdown();
        showEnded(reason);
      }

      function updateCountdown() {
        if (!promptActive || !countdownEndsAt) {
          return;
        }
        const remainingMs = countdownEndsAt - Date.now();
        if (remainingMs <= 0) {
          endSession('idle-timeout');
          return;
        }
        const remainingSeconds = Math.ceil(remainingMs / 1000);
        const mins = Math.floor(remainingSeconds / 60);
        const secs = remainingSeconds % 60;
        countdownEl.textContent = `Stopping in ${mins}:${String(secs).padStart(2, '0')}`;
      }

      function startCountdown(startedAt) {
        if (promptActive) {
          return;
        }
        overlay.style.display = 'flex';
        promptActive = true;
        textEl.textContent = `No activity detected for ${idleMinutes} minute${idleMinutes === 1 ? '' : 's'}.`;
        const baseline = startedAt || Date.now();
        countdownEndsAt = baseline + countdownSeconds * 1000;
        updateCountdown();
        if (countdownTimer) {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
        if (promptActive && countdownEndsAt) {
          countdownTimer = setInterval(() => {
            updateCountdown();
          }, 1000);
        }
      }

      function scheduleIdleTimer() {
        if (idleTimer) clearTimeout(idleTimer);
        if (idleSuspended) {
          return;
        }
        const delay = Math.max(0, (idleStartsAt || Date.now()) - Date.now());
        idleTimer = setTimeout(() => startCountdown(idleStartsAt), delay);
      }

      let lastActivitySentAt = 0;

      function notifyOpenerActivity(timestamp) {
        const target = openerRef || window.opener;
        if (!target) {
          return;
        }
        try {
          if (target.closed) {
            return;
          }
        } catch (err) {
          return;
        }
        const now = timestamp || Date.now();
        if (now - lastActivitySentAt < 1000) {
          return;
        }
        lastActivitySentAt = now;
        try {
          target.postMessage({ type: 'idle-activity', source: 'vm', instanceId, timestamp: now }, openerOrigin);
        } catch (err) {
          // ignore postMessage failures
        }
      }

      function notifyOpenerFocus(focused) {
        const target = openerRef || window.opener;
        if (!target) {
          return;
        }
        try {
          if (target.closed) {
            return;
          }
        } catch (err) {
          return;
        }
        const now = Date.now();
        try {
          target.postMessage(
            { type: focused ? 'idle-focus' : 'idle-blur', source: 'vm', instanceId, timestamp: now },
            openerOrigin,
          );
        } catch (err) {
          // ignore postMessage failures
        }
      }

      function startPresenceHeartbeat() {
        if (presenceTimer) {
          return;
        }
        presenceTimer = setInterval(() => {
          notifyOpenerFocus(!document.hidden);
        }, PRESENCE_INTERVAL_MS);
      }

      function stopPresenceHeartbeat() {
        if (!presenceTimer) {
          return;
        }
        clearInterval(presenceTimer);
        presenceTimer = null;
      }

      function startOpenerWatchdog() {
        if (openerWatchTimer) {
          return;
        }
        openerWatchTimer = setInterval(() => {
          let openerClosed = false;
          try {
            if (openerRef && openerRef.closed) {
              openerRef = null;
              openerClosed = true;
            }
          } catch (err) {
            openerRef = null;
            openerClosed = true;
          }
          try {
            if (window.opener && window.opener.closed) {
              openerClosed = true;
            }
          } catch (err) {
            openerClosed = true;
          }
          if (openerClosed && idleSuspended) {
            idleSuspended = false;
            recordActivity({ heartbeat: true });
          }
        }, OPENER_WATCH_INTERVAL_MS);
      }

      function stopOpenerWatchdog() {
        if (!openerWatchTimer) {
          return;
        }
        clearInterval(openerWatchTimer);
        openerWatchTimer = null;
      }

      function recordActivity({ emit = true, timestamp, heartbeat = false } = {}) {
        const now = timestamp || Date.now();
        if (idleSuspended) {
          if (heartbeat) {
            sendHeartbeat(now);
          }
          return;
        }
        if (promptActive) {
          return;
        }
        idleStartsAt = now + Math.max(1, idleMinutes) * 60 * 1000;
        scheduleIdleTimer();
        if (emit) {
          notifyOpenerActivity(now);
        }
        if (heartbeat) {
          sendHeartbeat(now);
        }
      }

      function syncIdleState() {
        if (idleSuspended) {
          return;
        }
        if (promptActive) {
          updateCountdown();
          return;
        }
        if (idleStartsAt && Date.now() >= idleStartsAt) {
          startCountdown(idleStartsAt);
          return;
        }
        scheduleIdleTimer();
      }

      function startIdleTimer() {
        recordActivity({ heartbeat: true });
        const onActivity = () => recordActivity({ heartbeat: true });
        const activityEvents = ['mousemove', 'keydown', 'mousedown', 'touchstart', 'touchmove', 'wheel', 'scroll'];
        activityEvents.forEach((evt) => {
          document.addEventListener(evt, onActivity, { passive: true, capture: true });
        });
        window.addEventListener('focus', () => {
          notifyOpenerFocus(true);
          idleSuspended = false;
          recordActivity({ heartbeat: true });
        });
        window.addEventListener('blur', () => {
          notifyOpenerFocus(false);
        });
        document.addEventListener('visibilitychange', () => {
          notifyOpenerFocus(!document.hidden);
          if (!document.hidden) {
            idleSuspended = false;
            recordActivity({ heartbeat: true });
          }
        });
        window.addEventListener('message', (event) => {
          const payload = event.data || {};
          if (payload.type === 'idle-handshake' && payload.source === 'user') {
            openerRef = event.source;
            openerOrigin = event.origin || '*';
            try {
              if (payload.instanceId === instanceId) {
                openerRef.postMessage(
                  { type: 'idle-handshake-ack', source: 'vm', instanceId },
                  openerOrigin,
                );
              }
            } catch (err) {
              // ignore postMessage failures
            }
            notifyOpenerFocus(!document.hidden);
            return;
          }
          if (payload.type === 'idle-focus' && payload.source === 'user') {
            idleSuspended = true;
            if (idleTimer) {
              clearTimeout(idleTimer);
              idleTimer = null;
            }
            stopCountdown();
            return;
          }
          if (payload.type === 'idle-blur' && payload.source === 'user') {
            idleSuspended = false;
            const ts = Number.isFinite(payload.timestamp) ? payload.timestamp : Date.now();
            recordActivity({ emit: false, timestamp: ts, heartbeat: false });
            return;
          }
          if (payload.type === 'idle-activity' && payload.source === 'user') {
            openerRef = event.source;
            openerOrigin = event.origin || '*';
            if (promptActive) {
              stopCountdown();
            }
            const ts = Number.isFinite(payload.timestamp) ? payload.timestamp : Date.now();
            recordActivity({ emit: false, timestamp: ts, heartbeat: false });
            return;
          }
          if (payload.type === 'idle-auth' && payload.source === 'user') {
            if (payload.instanceId && payload.instanceId !== instanceId) {
              return;
            }
            if (payload.token) {
              authToken = payload.token;
              try {
                sessionStorage.setItem(AUTH_STORAGE_TOKEN_KEY, authToken);
              } catch (err) {
                // ignore storage failures
              }
            }
            if (payload.apiBase) {
              apiBase = payload.apiBase;
              try {
                sessionStorage.setItem(AUTH_STORAGE_API_KEY, apiBase);
              } catch (err) {
                // ignore storage failures
              }
            }
            startBackendHeartbeat();
            sendHeartbeat(Date.now());
          }
        });
        document.getElementById('idle-continue').addEventListener('click', () => {
          stopCountdown();
          recordActivity({ heartbeat: true });
        });
        document.getElementById('idle-stop').addEventListener('click', () => {
          endSession('user-end');
        });
        startPresenceHeartbeat();
        startOpenerWatchdog();
        startBackendHeartbeat();
      }
    </script>
  </body>
</html>
